#!/bin/sh

set -e
set -u

WORK_DIR=
VCL_FILE=
WARMUP=
SCRIPT="$0"

usage() {
	cat <<-EOF
	Error: $1.

	Usage: $SCRIPT [-n <workdir>] [-w <warmup>] [<file>]

	Reload and use a VCL on a running Varnish instance. Options must be
	specified in that order when used:

	-n <workdir> : for a different working directory for varnishd
	-w <warmup>  : the waiting period between load and use operations

	When <file> is empty or missing, the active VCL's file is used but
	will fail if the active VCL wasn't loaded from a file.

	Upon success, the name of the loaded VCL is constructed from the
	current date and time, for example:

	    $(vcl_reload_name)
	EOF
	exit 1
}

varnishadm() {
	if ! OUTPUT=$(command varnishadm -n "$WORK_DIR" -- "$@" 2>&1)
	then
		echo "Command: varnishadm -n '$WORK_DIR' -- $*"
		echo
		echo "$OUTPUT"
		echo
		exit 1
	fi >&2
	echo "$OUTPUT"
}

fail() {
	echo "Error: $*" >&2
	exit 1
}

vcl_file() {
	VCL_SHOW="$(varnishadm vcl.show -v "$1")" ||
	fail "failed to get the VCL file name"

	echo "$VCL_SHOW" |
	awk '$1 == "//" && $2 == "VCL.SHOW" {print $NF; exit}'
}

vcl_active_name() {
	VCL_LIST="$(varnishadm vcl.list)" ||
	fail "failed to get the active VCL name"

	echo "$VCL_LIST" |
	awk '$1 == "active" {print $NF}'
}

vcl_active_file() {
	set -e
	VCL_NAME=$(vcl_active_name)
	vcl_file "$VCL_NAME"
}

vcl_reload_name() {
	printf "reload_%s" "$(date +%Y%m%d_%H%M%S)"
}

if [ $# -gt 0 ] && [ "$1" = -n ]
then
	test $# -gt 1 || usage "missing argument to -n"
	WORK_DIR="$2"
	shift 2
fi

if [ $# -gt 0 ] && [ "$1" = -w ]
then
	test $# -gt 1 || usage "missing argument to -w"
	WARMUP="$2"
	shift 2
fi

test $# -gt 1 && usage "too many arguments"
test $# -eq 1 && VCL_FILE="$1"

if [ -z "$VCL_FILE" ]
then
	VCL_FILE=$(vcl_active_file)

	case $VCL_FILE in
	/*) ;;
	*) fail "active VCL file not found (got $VCL_FILE)" ;;
	esac
fi

RELOAD_NAME=$(vcl_reload_name)

varnishadm vcl.load "$RELOAD_NAME" "$VCL_FILE"

test -n "$WARMUP" && sleep "$WARMUP"

varnishadm vcl.use  "$RELOAD_NAME"
